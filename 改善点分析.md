# 女子軟式野球部 出欠管理システム — 改善点分析

## 1. セキュリティ

### 1.1 管理者ページのアクセス制御（重要度: 高）

- **現状**: `appsscript.json` で `access: "ANYONE_ANONYMOUS"` のため、**URL を知っていれば誰でも管理者ページ（`?page=admin`）にアクセス**でき、スケジュールの編集・出欠の閲覧が可能。
- **改善案**:
  - 管理者ページのみ「自分」または「ドメイン内」にし、部員ページだけ「全員」にする（デプロイを2つに分ける必要あり）。
  - または、管理者ページ表示時に `Session.getActiveUser().getEmail()` で実行ユーザーを取得し、許可リスト（Config やプロパティで管理）と照合して、不一致なら部員ページにリダイレクトする。

### 1.2 入力値の検証・サニタイズ

- **現状**: 部員名（`name`）に長さ・文字種のチェックがほぼない。極端に長い名前や `,` を含む名前でシートのパースが崩れる可能性がある。
- **改善案**:
  - サーバー側（Controller）で `name` の長さ制限（例: 1〜20文字）、禁止文字（カンマ・改行など）をチェックし、不正ならエラーを返す。
  - 年月日（year, month, day）の範囲チェックを強化（例: 2000〜2100年、month 1〜12、day 1〜31）。

### 1.3 include() の引数

- **現状**: `include(filename)` には HTML 内で固定文字列（`member_css` など）のみが渡されている。
- **推奨**: 今後も **ユーザー入力や URL パラメータを include() に渡さない** こと。渡すとパストラバーサルや意図しないファイル読み込みの原因になる。

---

## 2. UX / UI

### 2.1 部員ページ

- **名簿の二重管理**: `member.html` に名前の `<option>` がハードコードされており、`Config.gs` の `DEFAULT_ROSTER` やプロパティの名簿と**同期していない**。名簿を変更しても部員ページのドロップダウンは更新されない。
- **改善案**: 初回データ取得で `roster` を返しているので、**JS で `<select>` の option を動的生成**する。`member_js.html` の `getMemberData` 成功時に `#memberSelect` の中身を `roster` から組み立てる。

- **ローディング表示**: キャッシュヒット時は一瞬で描画されるが、サーバー取得時は `setLoading(true)` でオーバーレイが出る。**初回のみスケルトンや「しばらくお待ちください」**を明示すると親切。

- **オフライン・通信失敗**: 保存失敗時にトーストで「通信エラー」と出るが、**リトライボタン**や「あとで送信」の案内があるとよい。

### 2.2 管理者ページ

- **保存後の二重フィードバック**: `flushPatch` 成功時に `setStatus("登録しました。")` と `alert("登録しました。")` の両方が出る。**alert をやめて status またはトーストのみ**にするとスムーズ。

- **一括設定の説明**: 「曜日を選択→午前ON」等の流れが初見では分かりにくい場合がある。**短い説明ラベルやツールチップ**があるとよい。

- **グラフの期間**: `getStatsForGraph(..., 6)` で直近6ヶ月固定。**期間を選択できる UI**（3/6/12ヶ月など）があると便利。

---

## 3. パフォーマンス・負荷

### 3.1 既に実施済み

- 出欠の月単位書き込みの一括化、キャッシュの `getAll` 化、ログの一括追記は済み。

### 3.2 追加で検討できる点

- **getPersonalStats**: スケジュール・出欠シートを毎回 `getDataRange().getValues()` で全件読んでいる。月が増えるとシートが肥大化するため、**対象月だけに絞った範囲読み**や、**結果のキャッシュ**（例: キー＝名前+年月、有効時間短め）を検討できる。

- **部員ページの localStorage キャッシュ**: 現在は月ごとにキャッシュ。**キャッシュの有効時間（例: 5分）**を設け、古いキャッシュはサーバー再取得すると、他者が更新した内容が早く反映される。

---

## 4. コード品質・保守性

### 4.1 重複・共通化

- **部員/管理者のタブ・カレンダー描画**: `visibleMonths()` や週の並び（月〜日）、カレンダーセルの描画ロジックが member と admin で似ている。**共通のユーティリティ（日付・表示用の小さな関数）**を別ファイルや共通 JS に切り出すと修正が一箇所で済む。

- **定数の一元化**: `monthsCount = 4` やキャッシュキーの "v6" がフロント側に分散。**Config やサーバーから「表示月数」「キャッシュバージョン」を返す**か、少なくともコメントで「Config の名簿と合わせて変更すること」と明記するとよい。

### 4.2 エラーハンドリング

- **google.script.run の withFailureHandler**: 多くの箇所で `err` を引数に取っているが中身をログに出していない。**開発時は `console.log(err)` や画面のデバッグ用エリアに表示**すると原因調査がしやすい（本番では無効化可能にする）。

- **Repo 層**: シートが存在しない・ヘッダーが想定と違う場合に `null` や `{}` を返している。**呼び出し元で「データが取得できませんでした」とユーザーに伝える**とよい。

### 4.3 名前の表記ゆれ

- **「登録」と「保存」**: 管理者は「変更を保存する」、保存後メッセージは「登録しました」など表記が混在。**「保存」に統一**するか、用語一覧をマニュアルに書いておくと分かりやすい。

---

## 5. 堅牢性・エッジケース

### 5.1 日付・数値

- **saveMemberResponseBatch の `changes`**: `item.day` が文字列で渡される想定。`parseInt(item.day, 10)` で数値化しているが、**不正な日（0や32など）**をはじく処理があると安全。

- **祝日カレンダー**: `CalendarApp.getCalendarById(calId)` が失敗した場合に `{}` を返している。**初回のみログに残す**か、管理者向けに「祝日を取得できていません」と表示する選択肢がある。

### 5.2 シート構造の変化

- ユーザーが手動で列を削除・並べ替えすると、`_detectHeaderMap` の結果が変わり、読み書きがおかしくなる。**「推奨シート構成」をマニュアルや管理者向けヘルプで明示**し、運用で列を触らないよう案内するとよい。

### 5.3 ログシート

- `_getOrCreateLogSheet()` で別スプレッドシートを自動作成している。**ログが不要な環境**ではプロパティで無効化できるようにするか、ログ書き込み失敗時もメイン処理は続行する現状をマニュアルに書いておくとよい。

---

## 6. アクセシビリティ

- **部員ページ**: `aria-label`、`aria-live`、`role="button"` などが一部で使われており良い。タブ切り替えで **フォーカス管理**（選択したタブにフォーカスを移す）をするとキーボード操作がより分かりやすい。

- **管理者ページ**: ダッシュボードの `<tr onclick="showAdminGraph(...)">` は**キーボードでトリガーできない**。`onkeydown` で Enter/Space を受け付けるか、**ボタンやリンクで「グラフを見る」**にするとよい。

- **フォント**: 外部フォント（Rounded Mplus 1c）に依存。**読み込み失敗時のフォールバック**（`sans-serif`）は CSS で指定されているとよい。

---

## 7. 機能・運用の拡張案

- **名簿の管理画面**: 現在は GAS の「プロジェクトのプロパティ」か Config の変更で名簿を更新。**管理者ページに「名簿の編集」**を追加し、プロパティへ保存する API があると運用しやすい。

- **過去月の参照**: 部員ページは「今月から4ヶ月」など将来中心。**過去の出欠を閲覧のみ**できるようにする場合、対象月の範囲を設定で変えられるようにする。

- **エクスポート**: 出欠・スケジュールを **CSV や PDF でダウンロード**する機能があると、顧問の手元資料として便利。

- **デプロイの分離**: 部員用（ANYONE）と管理者用（自分 or ドメイン内）で **デプロイを2つ**作り、URL を使い分けると、管理者ページの露出を減らせる。

---

## 8. 改善の優先度まとめ

| 優先度 | 項目 | 内容 |
|--------|------|------|
| 高 | 管理者ページのアクセス制御 | URL を知れば誰でも編集できる状態の見直し |
| 高 | 部員名簿の動的表示 | HTML の固定 option を roster で動的生成 |
| 中 | 名前・日付のサーバー側検証 | 長さ・禁止文字・年月日の範囲チェック |
| 中 | 管理者の保存後メッセージ | alert をやめて status/トーストに統一 |
| 中 | 用語の統一 | 「登録」「保存」などを統一 |
| 低 | グラフ期間の選択 UI | 3/6/12ヶ月などを選べるようにする |
| 低 | エラーログの活用 | withFailureHandler で err を開発時に表示 |
| 低 | 名簿編集の管理画面 | 管理者が名簿を画面から変更できるようにする |

---

## 9. 更新履歴

- 初版: セキュリティ・UX・パフォーマンス・コード品質・堅牢性・アクセシビリティ・機能拡張の観点で改善点を整理。
