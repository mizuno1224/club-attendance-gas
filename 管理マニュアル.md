# 女子軟式野球部 出欠管理システム 管理マニュアル

## 1. 概要

本システムは **Google Apps Script (GAS)** と **Google スプレッドシート** で、部活の「活動予定」と「出欠」を管理する Web アプリです。

- **部員ページ**: 部員が自分の出欠（出席・欠席・遅刻・早退）を入力
- **管理者ページ**: 活動予定の編集・出欠一覧の確認・グラフ表示

---

## 2. システム構成

| 種類 | 説明 |
|------|------|
| **GAS プロジェクト** | バックエンド（Main.gs, Controller.gs, Service.gs 等）＋ Web アプリとして配信 |
| **紐づくスプレッドシート** | 1 つのスプレッドシートに「活動予定」「出欠」シートが存在 |
| **部員ページ** | `?page=member` またはパラメータなしで表示 |
| **管理者ページ** | `?page=admin` で表示 |

### 主なファイル

| ファイル | 役割 |
|----------|------|
| `Main.gs` | Web アプリの `doGet`、スプレッドシートメニュー、`include()` |
| `Controller.gs` | 部員/管理者用 API（データ取得・スケジュール保存・出欠保存） |
| `Service.gs` | スケジュール/出欠の取得・祝日取得・キャッシュ・統計 |
| `Config.gs` | 定数（名簿・タイムゾーン・シート名候補・列の別名） |
| `Repo_Schedule.gs` | 活動予定シートの読み書き |
| `Repo_Attendance.gs` | 出欠シートの読み書き |
| `Repo_Log.gs` | 操作ログ |
| `Utils.gs` | 共通ユーティリティ |
| `admin.html` / `member.html` | 管理者・部員用 UI |
| `admin_js.html` / `member_js.html` | 各ページ用 JavaScript |
| `admin_css.html` / `member_css.html` | 各ページ用 CSS |

---

## 3. スプレッドシートのシート構成

GAS は「**現在紐づいているスプレッドシート**」のシートを参照します。`.clasp.json` の `scriptId` で GAS プロジェクトは決まりますが、スクリプトは「その GAS を開いたときのアクティブなスプレッドシート」を使います。**ウェブアプリとしてデプロイした場合も、スクリプトが紐づいているスプレッドシート**がデータ源です。

### 3.1 活動予定シート（スケジュール）

次の**いずれかの名前**のシートを 1 枚用意します。

- `活動予定` / `スケジュール` / `Schedule` / `schedule`

**推奨列（ヘッダーの別名も可）:**

| 列の意味 | 例となるヘッダー名 |
|----------|-------------------|
| 日付 | 日付, 日, Date, 日にち |
| 休み | 休み, オフ, OFF |
| 午前 | 午前, AM, 朝, morning |
| 午後 | 午後, PM, afternoon |
| 業後 | 業後, after, 夜, ナイター |
| メモ | メモ, 備考, 内容, note |
| 場所 | 場所, 会場, グラウンド, place |
| 時間 | 時間, 集合, 集合時間, time |

### 3.2 出欠シート

次の**いずれかの名前**のシートを 1 枚用意します。

- `出欠` / `出席` / `Attendance` / `attendance`

**推奨列:**

| 列の意味 | 例となるヘッダー名 |
|----------|-------------------|
| 日付 | 日付, 日, Date |
| 出席 | 出席, 参加, present |
| 欠席 | 欠席, 不参加, absent |
| 遅刻 | 遅刻, tardy, Late |
| 早退 | 早退, early |

出席・欠席・遅刻・早退のセルには、**カンマ区切りで名前**を入れます（例: `ゆうり,みゆ,のぞみ`）。

---

## 4. 開発環境（Git + clasp）

以下のコードブロック内のコマンドは、**そのままターミナルにコピー＆ペーストして実行**できます。プロンプト（`$` など）は含めず、コマンドのみ記載しています。

**※ コピーするとき**: 「\`\`\`」の行（コードブロックの枠）は**含めず**、**コマンドの行だけ**を選択してコピーしてください。枠まで含めて貼り付けるとターミナルでエラーになります。

### 4.1 前提

- **Node.js** がインストールされていること（`node -v` で確認）
- このリポジトリをクローンしたフォルダで作業すること

### 4.2 リポジトリ

- **Git**: リモートは `https://github.com/mizuno1224/club-attendance-gas.git`
- ブランチ: `main`
- コードの更新はローカルで行い、Git で共有します。

### 4.3 clasp のインストール（初回のみ）

```
npm install -g @google/clasp
```

### 4.4 Google アカウントでログイン（初回のみ）

```
clasp login
```

ブラウザが開くので、GAS を管理する Google アカウントで承認してください。

### 4.5 よく使う clasp コマンド（説明）

| コマンド | 説明 |
|----------|------|
| `clasp push` | ローカルのコードを GAS にアップロード |
| `clasp push --watch` | ファイル変更を監視し、保存のたびに自動で push |
| `clasp pull` | GAS 上のコードをローカルに上書き取得 |
| `clasp open` | ブラウザで GAS エディタを開く |
| `clasp deploy` | 新しいデプロイを作成（バージョン管理用） |

**注意**: `.clasp.json` があるディレクトリ（本プロジェクトのルート）で実行してください。`.claspignore` で `.git` や `memo.txt` などは push 対象外です。

### 4.6 コピー＆ペースト用コマンド一覧

以下はそのまま貼り付けて実行できます。**各ブロックで「コマンドの行だけ」を選択してコピー**してください（\`\`\` の行はコピーしない）。

例: 「clasp login」と書いてある行だけを選択 → コピー → ターミナルに貼り付け。

**clasp（GAS 連携）**

```
npm install -g @google/clasp
```

```
clasp login
```

```
clasp push
```

```
clasp push --watch
```

```
clasp pull
```

```
clasp open
```

```
clasp deploy
```

**Git（変更の共有）**

```
git add .
```

```
git commit -m "メッセージをここに書く"
```

```
git push
```

**Node.js のバージョン確認**

```
node -v
```

---

## 5. ウェブアプリのデプロイ

1. **GAS エディタを開く**  
   - スプレッドシートから「拡張機能」→「Apps Script」、または `clasp open` で開いた先の GAS プロジェクト
2. **デプロイ**  
   - 「デプロイ」→「新しいデプロイ」
   - 種類: **ウェブアプリ**
   - 説明: 任意（例: 「部員・管理者用」）
   - **実行ユーザー**: 「自分」（または「アプリにアクセスするユーザー」で運用に合わせて選択）
   - **アクセスできるユーザー**: 「全員」（部員が匿名で開く場合は「全員」）
3. **URL を控える**  
   - 「ウェブアプリの URL」が発行されます。部員・管理者にこの URL を共有します。
   - 部員ページ: `https://script.google.com/.../exec`
   - 管理者ページ: `https://script.google.com/.../exec?page=admin`

### スプレッドシートメニューから開く場合

GAS に「部活」メニューを追加しています。スプレッドシートを開いた状態で:

- **部活** → **部員ページ（新しいタブ）** / **管理者ページ（新しいタブ）**  
  → 上記の URL を案内するダイアログが表示されます。
- **部活** → **部員ページ（サイドバー表示）** / **管理者ページ（サイドバー表示）**  
  → サイドバーで同じ UI を表示（要: 一度ウェブアプリとしてデプロイ済み）。

「先にウェブアプリとしてデプロイしてください」と出る場合は、上記の手順でデプロイを行ってください。

---

## 6. 運用の流れ

### 6.1 部員

1. 部員ページの URL を開く（またはスプレッドシートの「部活」メニューから案内されたリンクを開く）。
2. **名前を選択または入力**（名簿は管理者が設定したものから選べる場合があります）。
3. **年月**を選ぶ。
4. 各日の **出席・欠席・遅刻・早退** を入力し、**送信** または **一括送信**。
5. 保存されると「保存しました。」等のメッセージが表示されます。

### 6.2 管理者

1. 管理者ページの URL（`?page=admin` 付き）を開く。
2. **活動予定**  
   - 対象年月の「休み」「午前/午後/業後」「メモ」「場所」「時間」などを編集し、保存。
3. **出欠**  
   - 部員の出欠一覧やグラフで出席率などを確認。

---

## 7. 設定の変更（Config.gs）

| 定数 | 説明 | 例 |
|------|------|-----|
| `DEFAULT_ROSTER` | 名簿の初期値（プロパティ未設定時） | `["ゆうり", "みゆ", ...]` |
| `TZ` | タイムゾーン | `"Asia/Tokyo"` |
| `SCHEDULE_SHEET_CANDIDATES` | 活動予定シートの候補名 | `["活動予定", "スケジュール", ...]` |
| `ATTENDANCE_SHEET_CANDIDATES` | 出欠シートの候補名 | `["出欠", "出席", ...]` |
| `HEADER_ALIASES` | 列ヘッダーの別名 | 日付・休み・午前・出席・欠席など |

名簿を GAS の「プロジェクトのプロパティ」に `ROSTER_JSON` として JSON 配列で保存している場合は、そちらが優先されます。  
祝日は Google の「日本の祝日」カレンダーを参照しています。

---

## 8. トラブルシューティング

| 現象 | 確認・対処 |
|------|------------|
| 部員/管理者ページが真っ白・エラー | ウェブアプリとしてデプロイ済みか確認。ブラウザのコンソールでエラー内容を確認。 |
| 「先にウェブアプリとしてデプロイしてください」 | GAS で「デプロイ」→「新しいデプロイ」→「ウェブアプリ」でデプロイする。 |
| スケジュールや出欠が表示されない | 紐づいているスプレッドシートに「活動予定」「出欠」シートがあるか、ヘッダー名が一致しているか確認。 |
| clasp push でエラー | `clasp login` の状態か、`.clasp.json` の `scriptId` が正しいか確認。ネットワーク・権限も確認。 |
| ローカルと GAS で内容が食い違う | GAS 上で編集した場合は `clasp pull` でローカルに取り込む。競合する場合は手動でマージ。 |

---

## 9. フォルダ構成（参考）

```
club-attendance-gas/
├── .clasp.json          # clasp 設定（scriptId 等）
├── .claspignore         # clasp push の除外
├── .gitignore           # Git の除外
├── appsscript.json      # GAS ランタイム等の設定
├── Config.gs
├── Controller.gs
├── Main.gs
├── Repo_Attendance.gs
├── Repo_Log.gs
├── Repo_Schedule.gs
├── Service.gs
├── Utils.gs
├── admin.html / admin_css.html / admin_js.html
├── member.html / member_css.html / member_js.html
├── 管理マニュアル.md    # 本ファイル
└── memo.txt             # メモ（clasp push 対象外）
```

---

## 10. パフォーマンス最適化（実施済み）

- **出欠シートの書き込み**: 月全体保存（`_writeAttendanceToSheet`）を「日ごとの読み書き」から「1回読み→メモリで編集→1回書き」に変更し、スプレッドシート API 呼び出しを大幅削減。
- **1日分の書き込み**（`_writeAttendanceDay`）: 複数回の `setValue` を 1 回の `setValues` にまとめて書き込み。
- **キャッシュ**: データ取得時に `cache.get` 2 回を `cache.getAll([key1, key2])` 1 回に集約。キャッシュ有効時間は `Config.gs` の `CACHE_EXPIRATION` で統一。
- **ログ**: `_appendLogBatch` の `getRange` の範囲指定を修正（複数行を正しく追記）。

## 11. 更新履歴

- 処理速度の最適化（出欠一括書き込み・キャッシュ・ログの修正）。
- 管理マニュアルを新規作成（プロジェクト概要・シート構成・Git/clasp・デプロイ・運用・設定・トラブルシューティングを記載）。
